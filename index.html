<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tatti Players - Profiles (Firebase)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js CDN for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* CSS remains the same as in the original */
        :root {
            --dark-bg: #0c1524;
            --darker-bg: #080e1a;
            --accent-blue: #00f0ff;
            --accent-purple: #8a2be2;
            --accent-pink: #ff00d0;
            --surface-color: #121b2b;
            --card-color: #1a2539;
            --border-color: #2a3a54;
            --text-primary: #e0f7ff;
            --text-secondary: #a0b8c8;
            --status-success: #00e676;
            --status-warning: #ff9100;
            --status-danger': #ff1744;
            --highlight-effect: rgba(0, 240, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: radial-gradient(circle at top, var(--dark-bg), var(--darker-bg));
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background effect */
        .dynamic-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .dynamic-particle {
            position: absolute;
            border-radius: 50%;
            background: var(--accent-blue);
            opacity: 0.2;
            animation: float 15s infinite linear;
            filter: blur(1px);
        }

        @keyframes float {
            0% { transform: translate(0, 0); }
            25% { transform: translate(100px, 50px); }
            50% { transform: translate(200px, 0); }
            75% { transform: translate(100px, -50px); }
            100% { transform: translate(0, 0); }
        }

        /* Header styling */
        .site-header {
            background: rgba(12, 21, 36, 0.8);
            backdrop-filter: blur(10px);
            padding: 25px 0;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }

        .site-header h1 {
            margin: 0;
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 10px;
        }

        .site-header p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .user-id-display {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .user-id-display i {
            color: var(--accent-blue);
        }
        .user-id-display span {
            font-weight: 600;
            color: var(--text-primary);
        }

        .display-name-input-container {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 0 20px;
        }

        .display-name-input-container input[type="text"] {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            font-size: 1rem;
            width: 250px;
            max-width: 100%;
        }

        .display-name-input-container button {
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-purple));
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 0, 208, 0.3);
        }

        .display-name-input-container button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 0, 208, 0.4);
        }


        /* Navigation - Now for Side Drawer */
        .hamburger-btn {
            position: absolute;
            top: 25px;
            left: 20px;
            background: none;
            border: none;
            color: var(--accent-blue);
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 101; /* Above header content */
            transition: color 0.3s ease, transform 0.2s ease; /* Added transform */
        }

        .hamburger-btn:hover {
            color: var(--text-primary);
        }

        .hamburger-btn.clicked { /* Added for visual feedback */
            color: var(--accent-pink);
            transform: scale(1.1);
        }

        .side-drawer {
            position: fixed;
            top: 0;
            left: -300px; /* Hidden by default */
            width: 280px; /* Width of the drawer */
            height: 100%;
            background: var(--card-color);
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
            transition: left 0.3s ease-in-out;
            padding-top: 80px; /* Space for header */
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
        }

        .side-drawer.open {
            left: 0; /* Show the drawer */
        }

        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            opacity: 0;
            z-index: 999;
            transition: opacity 0.3s ease-in-out;
        }

        .drawer-overlay.visible {
            display: block; /* Ensure it becomes block for visibility */
            opacity: 1;
        }

        .main-nav {
            display: flex;
            flex-direction: column; /* Vertical links */
            padding: 20px 0;
        }

        .main-nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 15px 25px;
            margin: 5px 0;
            border-radius: 8px; /* Slightly less rounded for vertical list */
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex; /* For icon and text alignment */
            align-items: center;
            gap: 15px;
        }

        .main-nav a i {
            font-size: 1.2rem;
            color: var(--accent-blue);
        }

        .main-nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--highlight-effect), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s ease;
        }

        .main-nav a:hover {
            color: var(--text-primary);
            background: rgba(0, 240, 255, 0.1);
        }

        .main-nav a.active {
            color: var(--accent-blue);
            background: var(--highlight-effect);
            border-left: 4px solid var(--accent-blue); /* Highlight active link */
            padding-left: 21px; /* Adjust for border */
        }

        /* Dashboard layout */
        .dashboard {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .dashboard-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* Profile cards */
        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            position: relative;
        }

        .profile-card {
            background: var(--card-color);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 2;
        }

        .profile-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
        }

        .profile-header {
            display: flex;
            padding: 40px 25px 25px 25px;
            border-bottom: 1px solid var(--border-color);
            gap: 20px;
            align-items: center;
            min-height: 120px;
        }

        .profile-image {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 3px solid var(--surface-color);
            position: relative;
        }

        .profile-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modified to show a user icon when no image is present */
        .profile-image .fa-user-circle {
            font-size: 3.5rem; /* Larger icon size */
            color: var(--text-primary);
            opacity: 0.7;
        }

        .profile-image::after {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 50%;
            border: 2px solid var(--accent-blue);
            animation: profile-pulse 2s infinite; /* Renamed animation */
        }

        @keyframes profile-pulse { /* Renamed animation */
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.5; transform: scale(1); }
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h2 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(0, 230, 118, 0.15);
            color: var(--status-success);
            border: 1px solid var(--status-success);
        }

        .status-away {
            background: rgba(255, 145, 0, 0.15);
            color: var(--status-warning);
            border: 1px solid var(--status-warning);
        }

        .status-offline {
            background: rgba(255, 23, 68, 0.15);
            color: var(--status-danger);
            border: 1px solid var(--status-danger);
        }

        .profile-meta {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .profile-meta div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .profile-meta i {
            color: var(--accent-blue);
        }

        .profile-content {
            padding: 25px;
        }

        .profile-description {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.7;
        }

        .trait-list {
            list-style: none;
            margin-bottom: 25px;
        }

        .trait-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .trait-list li:last-child {
            border-bottom: none;
        }

        .trait-list i {
            color: var(--accent-blue);
            min-width: 20px;
        }

        .trait-list strong {
            color: var(--text-primary);
        }

        /* Analytics Page Specific Styling */
        .analytics-content {
            background: var(--card-color);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-top: 30px;
        }

        .analytics-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .analytics-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        /* Chart styling */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
            margin-top: 30px;
        }
        
        .analytics-card { /* Kept for general analytics cards if any are added later */
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .analytics-card h3 {
            font-size: 1.5rem;
            color: var(--accent-blue);
            margin-bottom: 10px;
        }

        .analytics-card p {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* Canvas styling */
        #playerBarChart {
            display: block;
            background-color: var(--surface-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-top: 30px;
            width: 100%; /* Make canvas responsive */
            height: 300px; /* Fixed height for consistency */
        }

        /* Page content display using classes */
        .page-content {
            display: none; /* Hide all pages by default */
        }

        .page-content.active-page {
            display: grid; /* Show active page as grid */
        }

        /* Player Description Styling */
        .player-description-card {
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
            margin-top: 20px;
            text-align: left;
            grid-column: 1 / -1; /* Span across all columns in the grid */
        }
        .player-description-card h3 {
            color: var(--accent-pink);
            margin-bottom: 10px;
        }
        .player-description-card p {
            font-size: 1rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* What If Page Specific Styling */
        .what-if-content {
            background: var(--card-color);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-top: 30px;
        }

        .what-if-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .what-if-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .story-form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .story-form label {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .story-form textarea {
            width: 100%;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            font-size: 1rem;
            min-height: 150px;
            resize: vertical;
        }

        .story-form button {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 240, 255, 0.3);
        }

        .story-form button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 240, 255, 0.4);
        }

        .stories-list {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .stories-list h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .story-item {
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .story-item p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .story-meta {
            font-size: 0.85rem;
            color: var(--text-primary);
            text-align: right;
            opacity: 0.7;
        }

        /* Custom Modal Styling */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none; /* Changed to none by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scale(0.95); /* Initial scale for animation */
        }

        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }

        .modal-content {
            background: var(--card-color);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 1px solid var(--border-color);
        }

        .modal-content p {
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-btn {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm-yes {
            background: linear-gradient(90deg, #00e676, #00c853);
            color: white;
        }

        .modal-btn.confirm-no {
            background: linear-gradient(90deg, #ff1744, #d50000);
            color: white;
        }

        .modal-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Story Action Buttons Styling */
        .story-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end; /* Align buttons to the right */
        }

        .story-actions button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .story-actions .edit-story-btn {
            background-color: var(--accent-blue);
            color: var(--darker-bg);
        }

        .story-actions .delete-story-btn {
            background-color: var(--status-danger);
            color: white;
        }

        .story-actions .save-story-btn {
            background-color: var(--status-success);
            color: white;
        }

        .story-actions .cancel-edit-btn {
            background-color: var(--text-secondary);
            color: var(--darker-bg);
        }

        .story-actions button:hover {
            opacity: 0.8;
        }

        .story-item textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--darker-bg);
            color: var(--text-primary);
            font-size: 1rem;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 10px;
        }
        .story-item p[contenteditable="true"] {
            border: 1px solid var(--accent-blue);
            padding: 10px;
            border-radius: 5px;
            background-color: var(--surface-color);
        }

        /* Welcome Modal Specific Styling */
        #welcomeModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none; /* Changed to none by default */
            justify-content: center;
            align-items: center;
            z-index: 1001; /* Higher than other modals */
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Prevent interaction when hidden */
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: scale(0.95); /* Initial scale for animation */
        }

        #welcomeModal.visible {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
        }

        #welcomeModal .modal-content {
            background: var(--dark-bg);
            border: 2px solid var(--accent-blue);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 240, 255, 0.3);
            max-width: 500px;
        }

        #welcomeModal h2 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        #welcomeModal p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        #welcomeModal input[type="text"] {
            width: calc(100% - 30px); /* Adjust for padding */
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
        }

        #welcomeModal button {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 240, 255, 0.4);
        }

        #welcomeModal button:hover {
            opacity: 0.9;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 240, 255, 0.5);
        }

        /* Utility class to hide main content */
        .main-content {
            display: none; /* Changed to none by default */
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Prevent interaction when hidden */
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(20px); /* Initial position for animation */
        }

        .main-content.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        /* Admin Page Specific Styling */
        .admin-content {
            background: var(--card-color);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-top: 30px;
        }

        .admin-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .admin-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .user-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .user-list-item {
            background: var(--surface-color);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .user-list-item span:first-child {
            font-weight: 600;
            color: var(--accent-blue);
        }

        .user-list-item span:last-child {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .admin-pin-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--surface-color);
            margin-top: 20px;
        }

        .admin-pin-section input[type="password"] {
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--darker-bg);
            color: var(--text-primary);
            font-size: 1rem;
            width: 250px;
            max-width: 100%;
            text-align: center;
        }

        .admin-pin-section button {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 240, 255, 0.3);
        }

        .admin-pin-section button:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 240, 255, 0.4);
        }

        #revokeAdminBtn {
            background-color: var(--status-danger);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: block; /* Ensure it's on its own line */
            margin-left: auto;
            margin-right: auto;
        }
        #revokeAdminBtn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .user-list-item button {
            background: var(--accent-purple);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .user-list-item button:hover {
            background-color: #7a1be2;
        }

        .admin-stories-view .story-item {
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .admin-stories-view .story-item .story-actions {
            justify-content: flex-start; /* Align delete button to left in admin view */
        }

        .admin-stories-view .story-item .delete-story-btn {
            background-color: var(--status-danger);
            color: white;
        }

        .admin-stories-view h3 {
            margin-bottom: 15px;
            color: var(--accent-blue);
        }

        .back-button-container {
            margin-top: 20px;
            text-align: center;
        }

        .back-button-container button {
            background: var(--accent-pink);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button-container button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Theme Selector Styling */
        .theme-selector {
            margin-top: 30px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid for themes */
            gap: 15px;
            margin-top: 15px;
        }

        .theme-btn {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .theme-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .theme-btn i {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .theme-btn.active-theme {
            border: 2px solid var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.3);
        }

        /* Polls Page Specific Styling */
        .polls-content {
            background: var(--card-color);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-top: 30px;
        }

        .polls-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-pink));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .polls-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .poll-form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .poll-form label {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .poll-form input[type="text"],
        .poll-form textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .poll-options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .poll-option-item {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
            gap: 10px;
            align-items: center;
        }

        .poll-option-item input {
            flex: 1;
            min-width: 120px; /* Ensure inputs don't get too small */
        }

        .poll-option-item button {
            background-color: var(--status-danger);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        .poll-option-item button:hover {
            background-color: #c0392b;
        }

        .add-option-btn {
            background: var(--accent-blue);
            color: var(--darker-bg);
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .add-option-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .create-poll-btn {
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 240, 255, 0.3);
            margin-top: 20px;
        }

        .create-poll-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 240, 255, 0.4);
        }

        /* Loading indicator for poll creation */
        #createPollLoader {
            display: none;
            margin-top: 20px;
            text-align: center;
            color: var(--accent-blue);
            font-size: 1.1rem;
        }
        #createPollLoader i {
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        .polls-list {
            margin-top: 40px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .polls-list h3 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            background: linear-gradient(90deg, var(--accent-pink), var(--accent-blue));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .poll-item {
            background: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .poll-item:hover {
            transform: translateY(-3px);
        }

        .poll-question {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 15px;
        }

        .poll-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .poll-option {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--card-color);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            position: relative; /* For progress bar */
            overflow: hidden; /* For progress bar */
        }

        .poll-option:hover:not(.voted) { /* Only hover if not already voted */
            background-color: rgba(0, 240, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .poll-option.voted {
            border-color: var(--status-success); /* Highlight voted option */
            background-color: rgba(0, 230, 118, 0.1);
        }

        .poll-option input[type="radio"] {
            margin-right: 5px;
            accent-color: var(--accent-purple); /* Style radio button */
            z-index: 1; /* Ensure radio button is clickable */
            position: relative;
        }

        .poll-option img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            flex-shrink: 0; /* Prevent image from shrinking */
            z-index: 1; /* Ensure image is above progress bar */
            position: relative;
        }

        .poll-option span {
            flex-grow: 1;
            font-size: 1rem;
            color: var(--text-primary);
            z-index: 1; /* Ensure text is above progress bar */
            position: relative;
        }

        .poll-vote-count {
            font-weight: bold;
            color: var(--accent-pink);
            min-width: 30px;
            text-align: right;
            z-index: 1; /* Ensure count is above progress bar */
            position: relative;
        }

        /* Progress bar styling */
        .poll-progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(0, 240, 255, 0.2), rgba(138, 43, 226, 0.2));
            width: 0%; /* Will be set by JS */
            transition: width 0.5s ease-out;
            z-index: 0; /* Behind other content */
        }

        .poll-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 10px;
        }

        .poll-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .poll-actions button {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }

        .poll-actions .delete-poll-btn {
            background-color: var(--status-danger);
            color: white;
        }
        .poll-actions .delete-poll-btn:hover {
            background-color: #c0392b;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-nav {
                flex-wrap: wrap;
                padding: 10px;
                justify-content: center;
            }
            
            .main-nav a {
                padding: 8px 15px;
                margin: 5px;
                font-size: 0.9rem;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .profile-header {
                flex-direction: column;
                text-align: center;
                padding: 60px 20px 20px 20px;
                min-height: 150px;
            }
            
            .profile-meta {
                justify-content: center;
            }
            
            .members-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid { /* This will now only affect the overall analytics content */
                grid-template-columns: 1fr;
            }

            .display-name-input-container {
                flex-direction: column;
                gap: 8px;
            }

            .display-name-input-container input[type="text"] {
                width: 100%;
            }

            #welcomeModal .modal-content {
                padding: 30px 20px;
            }

            #welcomeModal h2 {
                font-size: 2rem;
            }

            #welcomeModal input[type="text"] {
                width: 100%;
            }

            .admin-pin-section input[type="password"] {
                width: 100%;
            }

            .user-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .user-list-item span:last-child {
                text-align: left;
                width: 100%;
            }

            .user-list-item button {
                width: 100%;
                margin-top: 10px;
            }

            .theme-options {
                grid-template-columns: 1fr;
            }

            .poll-option-item {
                flex-direction: column;
                align-items: stretch;
            }
            .poll-option-item input {
                width: 100%; /* Full width on small screens */
                min-width: unset;
            }
        }
    </style>
</head>
<body>
    <!-- Background particles -->
    <div class="dynamic-background" id="dynamic-bg"></div>
    
    <header class="site-header">
        <button id="hamburgerBtn" class="hamburger-btn" aria-label="Open navigation menu">
            <i class="fas fa-bars"></i>
        </button>
        <h1>Tatti Players</h1>
        <p>Player Profiles & Analytics</p>
        <div class="user-id-display">
            <i class="fas fa-user-circle"></i> Your Display Name: <span id="displayUserId">Loading...</span>
        </div>
        <div class="display-name-input-container">
            <input type="text" id="displayNameInput" placeholder="Change your display name">
            <button id="saveDisplayNameBtn">Save Name</button>
        </div>
    </header>

    <!-- Side Drawer -->
    <div id="sideDrawer" class="side-drawer">
        <nav class="main-nav">
            <a href="#" class="nav-link active" data-target="dashboard-page"><i class="fas fa-home"></i> Dashboard</a>
            <a href="#" class="nav-link" data-target="analytics-page"><i class="fas fa-chart-line"></i> Analytics</a>
            <a href="#" class="nav-link" data-target="what-if-page"><i class="fas fa-question-circle"></i> What If</a>
            <a href="#" class="nav-link" data-target="community-stories-page"><i class="fas fa-users"></i> Community Stories</a>
            <a href="#" class="nav-link" data-target="polls-page"><i class="fas fa-poll"></i> Polls</a>
            <a href="#" class="nav-link" data-target="settings-page"><i class="fas fa-cog"></i> Settings</a>
        </nav>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawerOverlay" class="drawer-overlay"></div>

    <div class="main-content" style="display: none;">
        <!-- Dashboard Page Content -->
        <div id="dashboard-page" class="dashboard page-content active-page">
            <div class="dashboard-header">
                <div>
                    <h2><i class="fas fa-users"></i> Player Profiles</h2>
                </div>
            </div>

            <div class="members-grid" id="playerProfilesGrid">
                <!-- Player profiles will be dynamically loaded here -->
            </div>
        </div>

        <!-- Analytics Page Content -->
        <div id="analytics-page" class="dashboard page-content">
            <div class="analytics-content">
                <h2><i class="fas fa-chart-line"></i> Tatti Analytics</h2>
                <p>Here you can view your players' performance and stats.</p>
                
                <div class="chart-container">
                    <canvas id="playerBarChart"></canvas>
                </div>

                <!-- Player Description Container -->
                <div id="playerDescriptions" style="margin-top: 20px;">
                    <!-- Descriptions will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- What If Page Content -->
        <div id="what-if-page" class="dashboard page-content">
            <div class="what-if-content">
                <h2><i class="fas fa-feather-alt"></i> Share Your Story</h2>
                <p>Here you can share your "What If" stories. Your stories will be linked to your unique ID, and you will only be able to edit or delete your own stories.</p>
                
                <form id="storyForm" class="story-form">
                    <label for="storyText">Write Your Story:</label>
                    <textarea id="storyText" placeholder="Write your story here..." required></textarea>
                    <button type="submit">Submit Story</button>
                </form>

                <div class="stories-list">
                    <h3>Your Shared Stories</h3>
                    <div id="sharedStoriesContainer">
                        <!-- Stories will be dynamically loaded here -->
                        <p style="text-align: center; color: var(--text-secondary);">Loading stories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Community Stories Page Content -->
        <div id="community-stories-page" class="dashboard page-content">
            <div class="what-if-content">
                <h2><i class="fas fa-globe"></i> Community Stories</h2>
                <p>Here you can view all shared stories from other users. You will only be able to edit or delete your own stories.</p>
                
                <div class="stories-list">
                    <h3>All Shared Stories</h3>
                    <div id="allSharedStoriesContainer">
                        <!-- All stories will be dynamically loaded here -->
                        <p style="text-align: center; color: var(--text-secondary);">Loading community stories...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Polls Page Content -->
        <div id="polls-page" class="dashboard page-content">
            <div class="polls-content">
                <h2><i class="fas fa-poll"></i> Create & Participate in Polls</h2>
                <p>Here you can create new polls and participate in polls from other users.</p>
                
                <form id="pollForm" class="poll-form">
                    <h3>Create a New Poll</h3>
                    <label for="pollQuestion">Poll Question:</label>
                    <input type="text" id="pollQuestion" placeholder="Enter your poll question" required>

                    <label>Poll Options (Minimum 2):</label>
                    <div id="pollOptionsContainer" class="poll-options-container">
                        <div class="poll-option-item">
                            <input type="text" class="poll-option-text" placeholder="Option 1 Text" required>
                            <input type="text" class="poll-option-image-url" placeholder="Option 1 Image URL (Optional)">
                            <button type="button" class="remove-option-btn" title="Remove this option"><i class="fas fa-minus-circle"></i></button>
                        </div>
                        <div class="poll-option-item">
                            <input type="text" class="poll-option-image-url" placeholder="Option 2 Image URL (Optional)">
                            <input type="text" class="poll-option-text" placeholder="Option 2 Text" required>
                            <button type="button" class="remove-option-btn" title="Remove this option"><i class="fas fa-minus-circle"></i></button>
                        </div>
                    </div>
                    <button type="button" id="addOptionBtn" class="add-option-btn"><i class="fas fa-plus-circle"></i> Add Option</button>
                    <button type="submit" class="create-poll-btn">Create Poll</button>
                    <div id="createPollLoader"><i class="fas fa-spinner fa-spin"></i> Creating poll...</div>
                </form>

                <div class="polls-list">
                    <h3>Active Polls</h3>
                    <div id="activePollsContainer">
                        <!-- Active polls will be dynamically loaded here -->
                        <p style="text-align: center; color: var(--text-secondary);">Loading polls...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Page Content -->
        <div id="settings-page" class="dashboard page-content">
            <div class="analytics-content">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <p>Here you can manage your app settings.</p>
                
                <div class="theme-selector">
                    <h3>Select Theme:</h3>
                    <div class="theme-options">
                        <button class="theme-btn active-theme" data-theme="original">
                            <i class="fas fa-palette"></i><br>
                            Original
                        </button>
                        <button class="theme-btn" data-theme="hacker">
                            <i class="fas fa-code"></i><br>
                            Hacker
                        </button>
                        <button class="theme-btn" data-theme="royal">
                            <i class="fas fa-crown"></i><br>
                            Royal
                        </button>
                        <button class="theme-btn" data-theme="anime">
                            <i class="fas fa-dragon"></i><br>
                            Anime
                        </button>
                    </div>
                </div>

                <!-- Admin Panel Content - Moved Here -->
                <div class="admin-content" style="margin-top: 40px;">
                    <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                    <p>Here you can view the display names and unique IDs of all users.</p>
                    
                    <!-- Admin PIN Section (initially visible if not admin) -->
                    <div id="adminPinSection" class="admin-pin-section">
                        <h3>Enter Admin PIN</h3>
                        <input type="password" id="adminPinInput" placeholder="Enter PIN to gain admin access">
                        <button id="grantAdminBtn">Grant Admin Access</button>
                    </div>

                    <!-- Admin User List Section (initially hidden) -->
                    <div id="adminUserListSection" style="display: none;">
                        <div id="userListContainer" class="user-list">
                            <p style="text-align: center; color: var(--text-secondary);">Loading users...</p>
                        </div>
                        <div id="adminUserStoriesView" class="admin-stories-view" style="display: none;">
                            <h3>Stories by <span id="currentAdminUserDisplayName"></span> (<span id="currentAdminUserId"></span>)</h3>
                            <div id="adminSpecificUserStoriesContainer">
                                <p style="text-align: center; color: var(--text-secondary);">Loading stories...</p>
                            </div>
                            <div class="back-button-container">
                                <button id="backToAllUsersBtn">Back to All Users</button>
                            </div>
                        </div>
                        <button id="revokeAdminBtn">Revoke Admin Access</button>
                    </div>
                </div>
            </div>
        </div>

    </div> <!-- End of main-content -->

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <p id="confirmMessage"></p>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="modal-btn confirm-yes">Yes</button>
                <button id="confirmNoBtn" class="modal-btn confirm-no">No</button>
            </div>
        </div>
    </div>

    <!-- Welcome Modal for Display Name -->
    <div id="welcomeModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h2>Welcome to Tatti Players!</h2>
            <p>Please enter a display name to start exploring the app and sharing your stories.</p>
            <input type="text" id="welcomeDisplayNameInput" placeholder="Enter your display name" required>
            <button id="startExploringBtn">Start Exploring</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        console.log("JavaScript script tag started."); // Debug Log

        // --- SACRED KEYS OF ACCESS ---
        const firebaseConfig = {
            apiKey: "AIzaSyARthJvOkPjkj2xoA1hE1pjRbRK83N15Cg",
            authDomain: "tatti-player.firebaseapp.com",
            databaseURL: "https://tatti-player-default-rtdb.firebaseio.com",
            projectId: "tatti-player",
            storageBucket: "tatti-player.firebasestorage.app",
            messagingSenderId: "657586845911",
            appId: "1:657586845911:web:70b7028b55854a7873d892",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); // Get a reference to the database service
        console.log("Firebase initialized."); // Debug Log

        // Global variables
        let userId; 
        let userDisplayName = ""; 
        let isAdmin = false; 
        let currentTheme = 'original'; 

        // Local storage key for initial userId
        const USER_ID_LOCAL_KEY = 'tatti_userId';
        
        // Define admin PIN
        const ADMIN_PIN = "859534"; 

        // Theme configurations
        const themes = {
            original: {
                '--dark-bg': '#0c1524',
                '--darker-bg': '#080e1a',
                '--accent-blue': '#00f0ff',
                '--accent-purple': '#8a2be2',
                '--accent-pink': '#ff00d0',
                '--surface-color': '#121b2b',
                '--card-color': '#1a2539',
                '--border-color': '#2a3a54',
                '--text-primary': '#e0f7ff',
                '--text-secondary': '#a0b8c8',
                '--status-success': '#00e676',
                '--status-warning': '#ff9100',
                '--status-danger': '#ff1744',
                '--highlight-effect': 'rgba(0, 240, 255, 0.15)'
            },
            hacker: {
                '--dark-bg': '#0a0a0a',
                '--darker-bg': '#001a00',
                '--accent-blue': '#00ff00',
                '--accent-purple': '#00aa00',
                '--accent-pink': '#00ff88',
                '--surface-color': '#0a1a0a',
                '--card-color': '#0f2a0f',
                '--border-color': '#004400',
                '--text-primary': '#00ff00',
                '--text-secondary': '#009900',
                '--status-success': '#00ff00',
                '--status-warning': '#ffff00',
                '--status-danger': '#ff0000',
                '--highlight-effect': 'rgba(0, 255, 0, 0.15)'
            },
            royal: {
                '--dark-bg': '#1a0a33',
                '--darker-bg': '#0d0519',
                '--accent-blue': '#9b59b6',
                '--accent-purple': '#8e44ad',
                '--accent-pink': '#e74c3c',
                '--surface-color': '#2c0d4d',
                '--card-color': '#3d1a66',
                '--border-color': '#5d2d8b',
                '--text-primary': '#f5d6ff',
                '--text-secondary': '#c9a0dc',
                '--status-success': '#2ecc71',
                '--status-warning': '#f39c12',
                '--status-danger': '#e74c3c',
                '--highlight-effect': 'rgba(155, 89, 182, 0.15)'
            },
            anime: {
                '--dark-bg': '#1e1e2e',
                '--darker-bg': '#161622',
                '--accent-blue': '#89dceb',
                '--accent-purple': '#cba6f7',
                '--accent-pink': '#f5c2e7',
                '--surface-color': '#2a2a3a',
                '--card-color': '#3a3a4a',
                '--border-color': '#585b70',
                '--text-primary': '#cdd6f4',
                '--text-secondary': '#a6adc8',
                '--status-success': '#a6e3a1',
                '--status-warning': '#f9e2af',
                '--status-danger': '#f38ba8',
                '--highlight-effect': 'rgba(137, 220, 235, 0.15)'
            }
        };

        // Helper function for modal/content visibility with transitions
        function toggleVisibility(element, show, displayType = 'flex', transitionDuration = 300) {
            console.log(`[toggleVisibility] Toggling visibility for element: #${element.id || element.className}. Show: ${show}, Display Type: ${displayType}.`); // Debug Log
            
            if (show) {
                element.style.display = displayType;
                element.offsetHeight; 
                element.classList.add('visible');
                element.style.pointerEvents = 'auto';
            } else {
                element.classList.remove('visible');
                element.style.pointerEvents = 'none';
                setTimeout(() => {
                    element.style.display = 'none';
                }, transitionDuration);
            }
        }

        // Custom Confirmation Modal Logic
        let confirmModalResolve;
        function showConfirmModal(message, onConfirmCallback = null) {
            console.log(`[showConfirmModal] Showing confirmation modal with message: "${message}".`); // Debug Log
            return new Promise((resolve) => {
                const modal = document.getElementById('customConfirmModal');
                const confirmMessage = document.getElementById('confirmMessage');
                const confirmYesBtn = document.getElementById('confirmYesBtn');
                const confirmNoBtn = document.getElementById('confirmNoBtn');

                confirmMessage.textContent = message;
                toggleVisibility(modal, true, 'flex');

                confirmModalResolve = resolve;

                confirmYesBtn.onclick = null;
                confirmNoBtn.onclick = null;

                confirmYesBtn.onclick = async () => {
                    toggleVisibility(modal, false);
                    if (onConfirmCallback) await onConfirmCallback();
                    confirmModalResolve(true);
                };
                confirmNoBtn.onclick = () => {
                    toggleVisibility(modal, false);
                    confirmModalResolve(false);
                };
            });
        }

        // Apply theme to the document
        function applyTheme(themeName) {
            console.log(`[applyTheme] Applying theme: ${themeName}.`); // Debug Log
            const theme = themes[themeName];
            if (!theme) return;

            const root = document.documentElement;
            
            Object.keys(theme).forEach(key => {
                root.style.setProperty(key, theme[key]);
            });

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active-theme');
                if (btn.dataset.theme === themeName) {
                    btn.classList.add('active-theme');
                }
            });

            currentTheme = themeName;
            
            if (document.getElementById('analytics-page').classList.contains('active-page')) {
                updateAnalyticsAndChart();
            }
        }

        // Helper function to darken a color
        function darkenColor(color, percent) {
            let r = parseInt(color.substring(1, 3), 16);
            let g = parseInt(color.substring(3, 5), 16);
            let b = parseInt(color.substring(5, 7), 16);
            
            r = Math.floor(r * (100 - percent) / 100);
            g = Math.floor(g * (100 - percent) / 100);
            b = Math.floor(b * (100 - percent) / 100);
            
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        }

        // Enhanced function to draw the bar chart with colors and legend
        function drawBarChart(canvasId, data, labels, colors) {
            console.log(`[drawBarChart] Drawing bar chart for ${canvasId}.`); // Debug Log
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`[drawBarChart] Canvas with ID '${canvasId}' not found.`);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const chartWidth = rect.width;
            const chartHeight = rect.height;
            const barWidth = chartWidth / (data.length * 2.5);
            const spacing = barWidth / 2;
            const maxVal = Math.max(...data);
            const scale = (chartHeight - 60) / (maxVal > 0 ? maxVal : 1);
            const bottomPadding = 40;
            const topPadding = 20;
            
            ctx.strokeStyle = 'var(--border-color)';
            ctx.lineWidth = 0.5;
            
            const gridLineCount = 5;
            for (let i = 0; i <= gridLineCount; i++) {
                const y = chartHeight - bottomPadding - (i * (chartHeight - bottomPadding - topPadding) / gridLineCount);
                ctx.beginPath();
                ctx.moveTo(30, y);
                ctx.lineTo(chartWidth - 10, y);
                ctx.stroke();
                
                ctx.fillStyle = 'var(--text-primary)';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxVal * i / gridLineCount), 25, y + 4);
            }
            
            for (let i = 0; i < data.length; i++) {
                const barHeight = data[i] * scale;
                const x = 40 + i * (barWidth + spacing);
                const y = chartHeight - bottomPadding - barHeight;
                
                const gradient = ctx.createLinearGradient(x, y, x, y + barHeight);
                gradient.addColorStop(0, colors[i]);
                gradient.addColorStop(1, darkenColor(colors[i], 20));
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.roundRect(x, y, barWidth, barHeight, [8, 8, 0, 0]);
                ctx.fill();
                
                ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
                ctx.shadowBlur = 5;
                ctx.shadowOffsetY = 3;
                ctx.fill();
                ctx.shadowColor = 'transparent';
                
                ctx.fillStyle = 'var(--text-primary)';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(data[i], x + barWidth / 2, y - 8);
                
                ctx.fillStyle = 'var(--text-primary)';
                ctx.font = '14px Arial';
                ctx.fillText(labels[i], x + barWidth / 2, chartHeight - 15);
            }
            
            ctx.save();
            ctx.fillStyle = 'var(--text-primary)';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.translate(15, chartHeight / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.fillText('Tatti Score', 0, 0);
            ctx.restore();
        }

        // --- Firebase Functions ---

        function getOrCreateUserId() {
            let id = localStorage.getItem(USER_ID_LOCAL_KEY);
            if (!id) {
                id = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem(USER_ID_LOCAL_KEY, id);
            }
            return id;
        }

        async function saveUserDisplayNameFirebase(name) {
            const currentUserId = getOrCreateUserId();
            if (!currentUserId) return false;
            try {
                const updates = {
                    displayName: name,
                    isAdmin: isAdmin,
                    theme: currentTheme
                };
                await database.ref('users/' + currentUserId + '/profile').update(updates);
                userDisplayName = name;
                document.getElementById('displayUserId').textContent = userDisplayName;
                return true;
            } catch (error) {
                console.error('Error saving display name to Firebase:', error);
                showConfirmModal('Failed to save display name. Please try again.');
                return false;
            }
        }

        async function loadUserProfileFirebase() {
            const currentUserId = getOrCreateUserId();
            if (!currentUserId) {
                showWelcomeModal();
                return;
            }

            try {
                const snapshot = await database.ref('users/' + currentUserId + '/profile').once('value');
                const profile = snapshot.val();
                
                if (profile) {
                    userDisplayName = profile.displayName || currentUserId;
                    isAdmin = profile.isAdmin || false;
                    currentTheme = profile.theme || 'original';
                } else {
                    userDisplayName = currentUserId;
                    isAdmin = false;
                    currentTheme = 'original';
                    showWelcomeModal();
                }
                
                document.getElementById('displayUserId').textContent = userDisplayName;
                document.getElementById('displayNameInput').value = userDisplayName;
                applyTheme(currentTheme);
                showMainContent();
                
            } catch (error) {
                console.error('Error loading user profile from Firebase:', error);
                document.getElementById('displayUserId').textContent = 'Error loading profile';
                showWelcomeModal();
            }
        }

        async function grantAdminAccessFirebase(userIdToGrant) {
            try {
                const updates = {
                    isAdmin: true,
                    lastAdminGranted: firebase.database.ServerValue.TIMESTAMP
                };
                await database.ref('users/' + userIdToGrant + '/profile').update(updates);
                isAdmin = true;
                updateAdminPanelUI();
                showConfirmModal('Admin access granted successfully!');
            } catch (error) {
                console.error('Error granting admin access:', error);
                showConfirmModal('Failed to grant admin access. Please try again.');
            }
        }

        async function revokeAdminAccessFirebase(userIdToRevoke) {
            try {
                const updates = {
                    isAdmin: false,
                    lastAdminRevoked: firebase.database.ServerValue.TIMESTAMP
                };
                await database.ref('users/' + userIdToRevoke + '/profile').update(updates);
                isAdmin = false;
                updateAdminPanelUI();
                showConfirmModal('Admin access revoked.');
            } catch (error) {
                console.error('Error revoking admin access:', error);
                showConfirmModal('Failed to revoke admin access. Please try again.');
            }
        }

        async function checkAdminAccessFirebase(userIdToCheck) {
            if (!userIdToCheck) return false;
            try {
                const snapshot = await database.ref('users/' + userIdToCheck + '/profile/isAdmin').once('value');
                return snapshot.val() === true;
            } catch (error) {
                console.error('Error checking admin access:', error);
                return false;
            }
        }

        async function saveThemeFirebase(themeName) {
            const currentUserId = getOrCreateUserId();
            if (!currentUserId) return;
            try {
                await database.ref('users/' + currentUserId + '/profile/theme').set(themeName);
            } catch (error) {
                console.error('Error saving theme to Firebase:', error);
            }
        }

        const storiesRef = database.ref('stories');

        async function addStoryToFirebase(storyText) {
            const currentUserId = getOrCreateUserId();
            if (!currentUserId) {
                showConfirmModal('Please set your display name first to share stories.');
                return;
            }

            try {
                const newStoryRef = storiesRef.push();
                const storyData = {
                    userId: currentUserId,
                    displayName: userDisplayName,
                    text: storyText,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };
                await newStoryRef.set(storyData);
                document.getElementById('storyText').value = '';
                showConfirmModal('Story submitted successfully!');
            } catch (error) {
                console.error('Error adding story to Firebase:', error);
                showConfirmModal('Failed to add story. Please try again.');
            }
        }

        function loadSharedStoriesFirebase() {
            const sharedStoriesContainer = document.getElementById('sharedStoriesContainer');
            sharedStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading your stories...</p>';
            const currentUserId = getOrCreateUserId();

            storiesRef.off('value', handleStoriesSnapshot);
            storiesRef.orderByChild('userId').equalTo(currentUserId).on('value', handleStoriesSnapshot, (error) => {
                console.error("Error loading stories from Firebase:", error);
                sharedStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--status-danger);">Error loading stories.</p>';
            });
        }

        function loadAllStoriesFirebase() {
            const allSharedStoriesContainer = document.getElementById('allSharedStoriesContainer');
            allSharedStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading community stories...</p>';

            storiesRef.off('value', handleAllStoriesSnapshotForCommunity);
            storiesRef.on('value', handleAllStoriesSnapshotForCommunity, (error) => {
                console.error("Error loading all stories from Firebase:", error);
                allSharedStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--status-danger);">Error loading community stories.</p>';
            });
        }

        function handleStoriesSnapshot(snapshot) {
            const sharedStoriesContainer = document.getElementById('sharedStoriesContainer');
            displayStories(snapshot, sharedStoriesContainer, true);
        }

        function handleAllStoriesSnapshotForCommunity(snapshot) {
            const allSharedStoriesContainer = document.getElementById('allSharedStoriesContainer');
            displayStories(snapshot, allSharedStoriesContainer, false);
        }

        function displayStories(snapshot, containerElement, showActions) {
            const storiesData = snapshot.val();
            containerElement.innerHTML = '';

            if (storiesData) {
                const storiesArray = Object.keys(storiesData).map(key => ({
                    id: key,
                    ...storiesData[key]
                })).sort((a, b) => b.timestamp - a.timestamp);

                if (storiesArray.length === 0) {
                    containerElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No stories found.</p>';
                    return;
                }

                storiesArray.forEach(story => {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'story-item';
                    storyItem.dataset.storyId = story.id;
                    storyItem.dataset.userId = story.userId;
                    const timestamp = story.timestamp ? new Date(story.timestamp).toLocaleString() : 'Unknown Date';
                    
                    let actionsHtml = '';
                    if (showActions && (story.userId === userId || isAdmin)) {
                        actionsHtml = `
                            <div class="story-actions">
                                <button data-story-id="${story.id}" class="edit-story-btn">Edit</button>
                                <button data-story-id="${story.id}" class="delete-story-btn">Delete</button>
                            </div>
                        `;
                    } else if (!showActions && isAdmin) {
                         actionsHtml = `
                            <div class="story-actions">
                                <button data-story-id="${story.id}" class="delete-story-btn">Delete (Admin)</button>
                            </div>
                        `;
                    }

                    storyItem.innerHTML = `
                        <p class="story-text" contenteditable="false">${story.text}</p>
                        <div class="story-meta">Shared by: ${story.displayName || 'Anonymous'} on ${timestamp}</div>
                        ${actionsHtml}
                    `;
                    containerElement.appendChild(storyItem);
                });
                if (showActions || isAdmin) {
                    attachStoryActionListeners(containerElement); 
                }
            } else {
                containerElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No stories found.</p>';
            }
        }

        async function updateStoryInFirebase(storyId, newText) {
            const currentUserId = getOrCreateUserId();
            try {
                const storyRef = database.ref('stories/' + storyId);
                const snapshot = await storyRef.once('value');
                const story = snapshot.val();

                if (story && (story.userId === currentUserId || isAdmin)) {
                    const updates = {
                        text: newText,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    await storyRef.update(updates);
                    showConfirmModal('Story updated successfully!');
                } else {
                    showConfirmModal('You are not authorized to edit this story.');
                }
            } catch (error) {
                console.error('Error updating story in Firebase:', error);
                showConfirmModal('Failed to update story. Please try again.');
            }
        }

        async function deleteStoryFromFirebase(storyId) {
            const currentUserId = getOrCreateUserId();
            try {
                const storyRef = database.ref('stories/' + storyId);
                const snapshot = await storyRef.once('value');
                const story = snapshot.val();

                const isAdminUser = isAdmin;
                if (story && (story.userId === currentUserId || isAdminUser)) {
                    await storyRef.remove();
                    showConfirmModal('Story deleted successfully!');
                } else {
                    showConfirmModal('You are not authorized to delete this story.');
                }
            } catch (error) {
                console.error('Error deleting story from Firebase:', error);
                showConfirmModal('Failed to delete story. Please try again.');
            }
        }

        function attachStoryActionListeners(container) {
            container.querySelectorAll('.edit-story-btn').forEach(button => {
                button.onclick = null;
                button.addEventListener('click', (event) => {
                    const storyId = event.target.dataset.storyId;
                    const storyItem = event.target.closest('.story-item');
                    const storyTextElement = storyItem.querySelector('.story-text');
                    const originalText = storyTextElement.textContent;

                    storyTextElement.contentEditable = true;
                    storyTextElement.focus();
                    storyItem.classList.add('editing');

                    const actionsDiv = storyItem.querySelector('.story-actions');
                    actionsDiv.innerHTML = `
                        <button data-story-id="${storyId}" class="save-story-btn">Save</button>
                        <button data-story-id="${storyId}" class="cancel-edit-btn">Cancel</button>
                    `;
                    attachEditSaveCancelListeners(storyId, storyTextElement, actionsDiv, originalText);
                });
            });

            container.querySelectorAll('.delete-story-btn').forEach(button => {
                button.onclick = null;
                button.addEventListener('click', (event) => {
                    const storyId = event.target.dataset.storyId;
                    showConfirmModal('Are you sure you want to delete this story?', async () => {
                        await deleteStoryFromFirebase(storyId);
                    });
                });
            });
        }

        function attachEditSaveCancelListeners(storyId, storyTextElement, actionsDiv, originalText) {
            actionsDiv.querySelector('.save-story-btn').addEventListener('click', async () => {
                const newText = storyTextElement.textContent.trim();
                if (!newText) {
                    showConfirmModal('Story cannot be empty.');
                    return;
                }
                await updateStoryInFirebase(storyId, newText);
                storyTextElement.contentEditable = false;
                storyTextElement.closest('.story-item').classList.remove('editing');
                if (document.getElementById('what-if-page').classList.contains('active-page')) {
                    loadSharedStoriesFirebase();
                } else if (document.getElementById('community-stories-page').classList.contains('active-page')) {
                    loadAllStoriesFirebase();
                } else if (document.getElementById('settings-page').classList.contains('active-page')) {
                    const currentAdminUserIdSpan = document.getElementById('currentAdminUserId');
                    const currentAdminUserDisplayNameSpan = document.getElementById('currentAdminUserDisplayName');
                    if (currentAdminUserIdSpan.textContent) {
                        viewUserStoriesAsAdmin(currentAdminUserIdSpan.textContent, currentAdminUserDisplayNameSpan.textContent);
                    } else {
                        loadAllUserProfilesFirebase();
                    }
                }
            });

            actionsDiv.querySelector('.cancel-edit-btn').addEventListener('click', () => {
                storyTextElement.textContent = originalText;
                storyTextElement.contentEditable = false;
                storyTextElement.closest('.story-item').classList.remove('editing');
                if (document.getElementById('what-if-page').classList.contains('active-page')) {
                    loadSharedStoriesFirebase();
                } else if (document.getElementById('community-stories-page').classList.contains('active-page')) {
                    loadAllStoriesFirebase();
                } else if (document.getElementById('settings-page').classList.contains('active-page')) {
                    const currentAdminUserIdSpan = document.getElementById('currentAdminUserId');
                    const currentAdminUserDisplayNameSpan = document.getElementById('currentAdminUserDisplayName');
                    if (currentAdminUserIdSpan.textContent) {
                        viewUserStoriesAsAdmin(currentAdminUserIdSpan.textContent, currentAdminUserDisplayNameSpan.textContent);
                    } else {
                        loadAllUserProfilesFirebase();
                    }
                }
            });
        }
        
        function loadAllUserProfilesFirebase() {
            const userListContainer = document.getElementById('userListContainer');
            userListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading users...</p>';
            
            database.ref('users').off('value', handleAllUsersSnapshot);
            database.ref('users').on('value', handleAllUsersSnapshot, (error) => {
                console.error("Error loading all user profiles from Firebase:", error);
                userListContainer.innerHTML = '<p style="text-align: center; color: var(--status-danger);">Error loading user list.</p>';
            });
        }

        function handleAllUsersSnapshot(snapshot) {
            const userListContainer = document.getElementById('userListContainer');
            const usersData = snapshot.val();
            userListContainer.innerHTML = '';

            if (usersData) {
                const usersArray = Object.keys(usersData).map(key => ({
                    userId: key,
                    displayName: usersData[key].profile?.displayName || key
                }));

                if (usersArray.length === 0) {
                    userListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No users found.</p>';
                    return;
                }
                
                usersArray.forEach(userData => {
                    const listItem = document.createElement('div');
                    listItem.className = 'user-list-item';
                    listItem.innerHTML = `
                        <span>${userData.displayName}</span>
                        <span>(ID: ${userData.userId})</span>
                        <button data-user-id="${userData.userId}" data-display-name="${userData.displayName}" class="view-user-stories-btn">View Stories</button>
                    `;
                    userListContainer.appendChild(listItem);
                });
                
                document.querySelectorAll('.view-user-stories-btn').forEach(button => {
                    button.onclick = null;
                    button.addEventListener('click', (event) => {
                        const targetUserId = event.target.dataset.userId;
                        const targetDisplayName = event.target.dataset.displayName;
                        viewUserStoriesAsAdmin(targetUserId, targetDisplayName);
                    });
                });
                
            } else {
                userListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No users found.</p>';
            }
        }

        function viewUserStoriesAsAdmin(targetUserId, targetDisplayName) {
            const userListContainer = document.getElementById('userListContainer');
            const adminUserStoriesView = document.getElementById('adminUserStoriesView');
            const currentAdminUserDisplayNameSpan = document.getElementById('currentAdminUserDisplayName');
            const currentAdminUserIdSpan = document.getElementById('currentAdminUserId');
            const adminSpecificUserStoriesContainer = document.getElementById('adminSpecificUserStoriesContainer');

            userListContainer.style.display = 'none';
            adminUserStoriesView.style.display = 'block';

            currentAdminUserDisplayNameSpan.textContent = targetDisplayName;
            currentAdminUserIdSpan.textContent = targetUserId;
            adminSpecificUserStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading stories for this user...</p>';

            storiesRef.off('value', handleAdminSpecificUserStoriesSnapshot);
            storiesRef.orderByChild('userId').equalTo(targetUserId).on('value', (snapshot) => {
                handleAdminSpecificUserStoriesSnapshot(snapshot, adminSpecificUserStoriesContainer);
            }, (error) => {
                console.error("Error fetching specific user stories for admin:", error);
                adminSpecificUserStoriesContainer.innerHTML = '<p style="text-align: center; color: var(--status-danger);">Error loading stories.</p>';
            });
        }

        function handleAdminSpecificUserStoriesSnapshot(snapshot, containerElement) {
            const userStoriesData = snapshot.val();
            containerElement.innerHTML = '';
            
            if (userStoriesData) {
                const userStories = Object.keys(userStoriesData).map(key => ({
                    id: key,
                    ...userStoriesData[key]
                })).sort((a, b) => b.timestamp - a.timestamp);
                
                if (userStories.length === 0) {
                    containerElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">This user has not posted any stories.</p>';
                    return;
                }
                
                userStories.forEach(story => {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'story-item';
                    storyItem.dataset.storyId = story.id;
                    storyItem.dataset.userId = story.userId;
                    const timestamp = story.timestamp ? new Date(story.timestamp).toLocaleString() : 'Unknown Date';
                    
                    storyItem.innerHTML = `
                        <p class="story-text">${story.text}</p>
                        <div class="story-meta">Shared by: ${story.displayName || story.userId} on ${timestamp}</div>
                        <div class="story-actions">
                            <button data-story-id="${story.id}" class="delete-story-btn">Delete Story (Admin)</button>
                        </div>
                    `;
                    containerElement.appendChild(storyItem);
                });
                
                document.querySelectorAll('#adminSpecificUserStoriesContainer .delete-story-btn').forEach(button => {
                    button.onclick = null;
                    button.addEventListener('click', (event) => {
                        const storyIdToDelete = event.target.dataset.storyId;
                        showConfirmModal('Are you sure you want to delete this story for ALL users?', async () => {
                            await deleteStoryFromFirebase(storyIdToDelete);
                        });
                    });
                });
                
            } else {
                containerElement.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">This user has not posted any stories.</p>';
            }
        }

        function backToAllUsers() {
            document.getElementById('userListContainer').style.display = 'flex';
            document.getElementById('adminUserStoriesView').style.display = 'none';
            storiesRef.off('value', handleAdminSpecificUserStoriesSnapshot);
            loadAllUserProfilesFirebase();
        }

        async function initializeApp() {
            userId = getOrCreateUserId();
            await loadUserProfileFirebase();
            initDynamicBackground();
            setupPageSwitching();
            setupThemeSelection();
            renderPlayerProfiles(playersData);
            updateAnalyticsAndChart();
        }

        function updateAdminPanelUI() {
            const adminPinSection = document.getElementById('adminPinSection');
            const adminUserListSection = document.getElementById('adminUserListSection');
            const userListContainer = document.getElementById('userListContainer');
            const adminUserStoriesView = document.getElementById('adminUserStoriesView');
            const revokeAdminBtn = document.getElementById('revokeAdminBtn');

            if (isAdmin) {
                adminPinSection.style.display = 'none';
                adminUserListSection.style.display = 'block';
                revokeAdminBtn.style.display = 'block';
                userListContainer.style.display = 'flex';
                adminUserStoriesView.style.display = 'none';
                loadAllUserProfilesFirebase();
            } else {
                adminPinSection.style.display = 'flex';
                adminUserListSection.style.display = 'none';
                revokeAdminBtn.style.display = 'none';
                adminUserStoriesView.style.display = 'none';
                userListContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Enter PIN to view user list.</p>';
                database.ref('users').off('value', handleAllUsersSnapshot);
                storiesRef.off('value', handleAdminSpecificUserStoriesSnapshot);
            }
        }

        function startEditStory(storyId, currentText) {
            const storyItem = document.querySelector(`.story-item[data-story-id="${storyId}"]`);
            if (!storyItem) return;

            const storyTextP = storyItem.querySelector('.story-text');
            const storyActionsDiv = storyItem.querySelector('.story-actions');

            storyTextP.contentEditable = true;
            storyTextP.focus();
            storyItem.classList.add('editing');

            storyActionsDiv.innerHTML = '';

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Save';
            saveButton.className = 'save-story-btn';
            saveButton.addEventListener('click', () => updateStoryInFirebase(storyId, storyTextP.textContent.trim()));
            storyActionsDiv.appendChild(saveButton);

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Cancel';
            cancelButton.className = 'cancel-edit-btn';
            cancelButton.addEventListener('click', () => {
                storyTextP.textContent = currentText;
                storyTextP.contentEditable = false;
                storyItem.classList.remove('editing');
                loadSharedStoriesFirebase();
            });
            storyActionsDiv.appendChild(cancelButton);
        }

        const playersData = [
            { 
                name: 'Naga Saki', 
                status: 'online', 
                tattiScore: 80, 
                description: 'Naga Saki is considered the darkest person in the world. Their performance has been consistent, making them an important player for the team.',
                pros: ['Respects their mother a lot.'],
                cons: ['But makes many mistakes.'],
                imageUrl: 'naga.png'
            },
            { 
                name: 'Ali Khan', 
                status: 'offline', 
                tattiScore: 99, 
                description: 'Ali Khan has shown exceptional performance, placing them at the top. Some circles refer to them as "Tatti" or "Shishimaru". Their fictional father is Barfula Khan. This breed is primarily found in indoor environments.',
                pros: ['Has many fathers.'],
                cons: ['But only calls Shailu, Ishan, Rounak \'father\'.'],
                imageUrl: 'ali.png'
            },
            { 
                name: 'Nxt Figo', 
                status: 'offline', 
                tattiScore: 75, 
                description: 'Nxt Figo is the most respected person in the Nxt group. His work is that he forced Nxt Sanya for self-happiness.',
                pros: ['Everyone respects them.'],
                cons: ['Sanya is their best friend.'],
                imageUrl: 'figo.png'
            },
            {
                name: 'Rudy',
                status: 'online',
                tattiScore: 88,
                description: 'Rudy, the "Punjab Ka Sher" of Indoor boxing, was born from the fierce spirit of Punjab. He\'s a famous boxer, known for his signature "Whoo Wooo Waa" cry and his unique choice of plastic underwear in public. Beyond the ring, he surprisingly possesses a keen understanding of data analytics,he is a model.',
                pros: ['Very famous boxer', 'Wears plastic underwear in public (unique style)', 'Knows data analytics'],
                cons: ['They only analyze data, not implement solutions'],
                imageUrl: 'rudy.png'
            },
            {
                name: 'Yuvi',
                status: 'online',
                tattiScore: 92,
                description: 'Yuvi, a boy from Indoor, resembles a hamster and possesses the unique power of cutting trees with his destructive teeth. His father, a Spider-Man villain named Electro, gifted him a handmade electric bullet.',
                pros: ['Girlfriend is Prostitute Jiya', 'God gave him chainsaw teeth'],
                cons: ['Latringboy beats him everyday,he carry a football ,Owner of bullet but rides chetak '],
                 imageUrl: 'yuvi.png'
            },
            {
                name: 'Francture',
                status: 'online',
                tattiScore: 95,
                description: 'Francture is a mythical creature from Japan named Kappa. He came to India to crack JEE and is a born chef. At night, he owns a sweet shop named "Francture ke Rasgulla". He wants to become an esport player but became an escort girl.',
                pros: ['Looks like Kappa', 'Has a record of making 50 samosas naked'],
                cons: ['His best friend is Ashiq', 'Has an iPhone but not a single bad habit'],
                imageUrl: 'franky.png' // Placeholder image for Francture
            }
        ];

        function renderPlayerProfiles(players) {
            const playerProfilesGrid = document.getElementById('playerProfilesGrid');
            playerProfilesGrid.innerHTML = '';

            for (const player of players) {
                const prosHtml = player.pros && player.pros.length > 0 ? `
                    <h3>Pros:</h3>
                    <ul>
                        ${player.pros.map(pro => `<li><i class="fas fa-check-circle" style="color: var(--status-success);"></i> ${pro}</li>`).join('')}
                    </ul>
                ` : '';

                const consHtml = player.cons && player.cons.length > 0 ? `
                    <h3>Cons:</h3>
                    <ul>
                        ${player.cons.map(con => `<li><i class="fas fa-times-circle" style="color: var(--status-danger);"></i> ${con}</li>`).join('')}
                    </ul>
                ` : '';


                const profileCard = document.createElement('div');
                profileCard.className = 'profile-card';
                profileCard.dataset.memberId = player.name.toLowerCase().replace(/\s/g, '-');
                profileCard.innerHTML = `
                    <div class="profile-header">
                        <div class="profile-image">
                            ${player.imageUrl ? `<img src="${player.imageUrl}" alt="${player.name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/0c1524/00f0ff?text=${player.name.split(' ').map(n=>n[0]).join('')}';">` : `<i class="fas fa-user-circle"></i>`}
                        </div>
                        <div class="profile-info">
                            <h2>${player.name} <span class="profile-status status-${player.status}">${player.status.charAt(0).toUpperCase() + player.status.slice(1)}</span></h2>
                            <div class="profile-meta">
                                <div><i class="fas fa-id-card"></i> Player ID: ${player.name.toLowerCase().replace(/\s/g, '-')}</div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-content">
                        <p class="profile-description">${player.description}</p>
                        ${prosHtml}
                        ${consHtml}
                        <ul class="trait-list">
                            <li><i class="fas fa-star"></i> <strong>Tatti Score:</strong> ${player.tattiScore}</li>
                            <li><i class="fas fa-gamepad"></i> <strong>Favorite Game:</strong> Not set</li>
                            <li><i class="fas fa-users"></i> <strong>Team Role:</strong> Player</li>
                            <li><i class="fas fa-fire"></i> <strong>Play Style:</strong> Adaptive</li>
                        </ul>
                    </div>
                `;
                playerProfilesGrid.appendChild(profileCard);
            }
        }

        function updateAnalyticsAndChart() {
            const playerDescriptionsContainer = document.getElementById('playerDescriptions');
            playerDescriptionsContainer.innerHTML = '';

            const sortedPlayers = [...playersData].sort((a, b) => b.tattiScore - a.tattiScore);

            const chartData = [];
            const chartLabels = [];
            const chartColors = currentTheme === 'hacker' ? 
                ['#00ff00', '#00cc00', '#009900', '#006600', '#003300'] : 
                currentTheme === 'royal' ? 
                ['#9b59b6', '#8e44ad', '#6c3483', '#562d7c', '#401f5c'] :
                currentTheme === 'anime' ?
                ['#89dceb', '#cba6f7', '#f5c2e7', '#b5a2e2', '#9786f0'] :
                ['#00f0ff', '#8a2be2', '#ff00d0', '#00aaff', '#ffcc00'];

            sortedPlayers.forEach((player, index) => {
                chartData.push(player.tattiScore);
                chartLabels.push(player.name);

                const descCard = document.createElement('div');
                descCard.className = 'player-description-card';
                descCard.style.display = 'block';
                descCard.innerHTML = `
                    <h3>${player.name} Performance Analysis:</h3>
                    <p>${player.description}</p>
                `;
                playerDescriptionsContainer.appendChild(descCard);
            });
            
            drawBarChart('playerBarChart', chartData, chartLabels, chartColors);
        }

        // --- Polls Functions ---

        const pollsRef = database.ref('polls');

        async function addPollToFirebase(question, options) {
            const currentUserId = getOrCreateUserId();
            if (!currentUserId) {
                showConfirmModal('Please set your display name first to create polls.');
                return;
            }

            const createPollBtn = document.querySelector('.create-poll-btn');
            const createPollLoader = document.getElementById('createPollLoader');
            createPollBtn.disabled = true;
            createPollLoader.style.display = 'block';

            try {
                const newPollRef = pollsRef.push();
                const pollData = {
                    question: question,
                    options: options.map(opt => ({ text: opt.text, imageUrl: opt.imageUrl || '' })),
                    votes: {},
                    creatorId: currentUserId,
                    creatorDisplayName: userDisplayName,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                options.forEach((_, index) => {
                    pollData.votes[index] = 0;
                });

                await newPollRef.set(pollData);
                document.getElementById('pollQuestion').value = '';
                const pollOptionsContainer = document.getElementById('pollOptionsContainer');
                pollOptionsContainer.innerHTML = `
                    <div class="poll-option-item">
                        <input type="text" class="poll-option-text" placeholder="Option 1 Text" required>
                        <input type="text" class="poll-option-image-url" placeholder="Option 1 Image URL (Optional)">
                        <button type="button" class="remove-option-btn" title="Remove this option"><i class="fas fa-minus-circle"></i></button>
                    </div>
                    <div class="poll-option-item">
                        <input type="text" class="poll-option-image-url" placeholder="Option 2 Image URL (Optional)">
                        <input type="text" class="poll-option-text" placeholder="Option 2 Text" required>
                        <button type="button" class="remove-option-btn" title="Remove this option"><i class="fas fa-minus-circle"></i></button>
                    </div>
                `; 
                attachRemoveOptionListeners();
                showConfirmModal('Poll created successfully!');
            } catch (error) {
                console.error('Error adding poll to Firebase:', error);
                showConfirmModal('Failed to create poll. Please try again.');
            } finally {
                createPollBtn.disabled = false;
                createPollLoader.style.display = 'none';
            }
        }

        function loadPollsFirebase() {
            const activePollsContainer = document.getElementById('activePollsContainer');
            activePollsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">Loading polls...</p>';
            pollsRef.off('value', handlePollsSnapshot);
            pollsRef.on('value', handlePollsSnapshot, (error) => {
                console.error("Error loading polls from Firebase:", error);
                activePollsContainer.innerHTML = '<p style="text-align: center; color: var(--status-danger);">Error loading polls.</p>';
            });
        }

        function handlePollsSnapshot(snapshot) {
            const activePollsContainer = document.getElementById('activePollsContainer');
            const pollsData = snapshot.val();
            activePollsContainer.innerHTML = '';

            if (pollsData) {
                const pollsArray = Object.keys(pollsData).map(key => ({
                    id: key,
                    ...pollsData[key]
                })).sort((a, b) => b.timestamp - a.timestamp);

                if (pollsArray.length === 0) {
                    activePollsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No active polls found.</p>';
                    return;
                }

                pollsArray.forEach(poll => {
                    const pollItem = document.createElement('div');
                    pollItem.className = 'poll-item';
                    pollItem.dataset.pollId = poll.id;

                    let optionsHtml = '';
                    let totalVotes = 0;
                    if (poll.votes) {
                        totalVotes = Object.values(poll.votes).reduce((sum, count) => sum + count, 0);
                    }

                    poll.options.forEach((option, index) => {
                        const voteCount = poll.votes ? (poll.votes[index] || 0) : 0;
                        const percentage = totalVotes > 0 ? ((voteCount / totalVotes) * 100).toFixed(1) : 0;
                        const imageUrl = option.imageUrl || 'https://placehold.co/50x50/1a2539/e0f7ff?text=No+Img';

                        const isVoted = poll.votedBy && poll.votedBy[userId] === index;
                        const isDisabled = poll.votedBy && poll.votedBy[userId] !== undefined;

                        optionsHtml += `
                            <label class="poll-option ${isVoted ? 'voted' : ''}">
                                <div class="poll-progress-bar" style="width: ${percentage}%;"></div>
                                <input type="radio" name="poll-${poll.id}" value="${index}" data-poll-id="${poll.id}" ${isVoted ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                                <img src="${imageUrl}" alt="Option Image" onerror="this.onerror=null;this.src='https://placehold.co/50x50/1a2539/e0f7ff?text=No+Img';">
                                <span>${option.text}</span>
                                <span class="poll-vote-count">${voteCount} votes (${percentage}%)</span>
                            </label>
                        `;
                    });

                    let actionsHtml = '';
                    if (poll.creatorId === userId || isAdmin) {
                        actionsHtml = `
                            <div class="poll-actions">
                                <button data-poll-id="${poll.id}" class="delete-poll-btn">Delete Poll</button>
                            </div>
                        `;
                    }

                    pollItem.innerHTML = `
                        <div class="poll-question">${poll.question}</div>
                        <div class="poll-options">
                            ${optionsHtml}
                        </div>
                        <div class="poll-meta">Created by: ${poll.creatorDisplayName || 'Anonymous'} on ${new Date(poll.timestamp).toLocaleString()}</div>
                        ${actionsHtml}
                    `;
                    activePollsContainer.appendChild(pollItem);
                });
                attachPollActionListeners();
            } else {
                activePollsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No active polls found.</p>';
            }
        }

        async function handlePollVote(pollId, optionIndex) {
            const pollRef = database.ref('polls/' + pollId);

            try {
                const snapshot = await pollRef.once('value');
                const poll = snapshot.val();

                if (!poll) {
                    showConfirmModal('Poll not found.');
                    return;
                }

                if (poll.votedBy && poll.votedBy[userId] !== undefined) {
                    showConfirmModal('You have already voted on this poll.');
                    return;
                }

                const newVotes = { ...poll.votes };
                newVotes[optionIndex] = (newVotes[optionIndex] || 0) + 1;

                const newVotedBy = { ...poll.votedBy, [userId]: optionIndex };

                const updates = {
                    votes: newVotes,
                    votedBy: newVotedBy
                };
                await pollRef.update(updates);
                showConfirmModal('Your vote has been recorded!');
            } catch (error) {
                console.error('Error casting vote:', error);
                showConfirmModal('Failed to cast vote. Please try again.');
            }
        }

        async function deletePollFromFirebase(pollId) {
            const currentUserId = getOrCreateUserId();
            try {
                const pollRef = database.ref('polls/' + pollId);
                const snapshot = await pollRef.once('value');
                const poll = snapshot.val();

                if (poll && (poll.creatorId === currentUserId || isAdmin)) {
                    await pollRef.remove();
                    showConfirmModal('Poll deleted successfully!');
                } else {
                    showConfirmModal('You are not authorized to delete this poll.');
                }
            } catch (error) {
                console.error('Error deleting poll from Firebase:', error);
                showConfirmModal('Failed to delete poll. Please try again.');
            }
        }

        function attachPollActionListeners() {
            document.querySelectorAll('.poll-option input[type="radio"]').forEach(radio => {
                radio.onclick = null;
                if (!radio.disabled) {
                    radio.addEventListener('change', (event) => {
                        const pollId = event.target.dataset.pollId;
                        const optionIndex = parseInt(event.target.value);
                        handlePollVote(pollId, optionIndex);
                    });
                }
            });

            document.querySelectorAll('.delete-poll-btn').forEach(button => {
                button.onclick = null;
                button.addEventListener('click', (event) => {
                    const pollId = event.target.dataset.pollId;
                    showConfirmModal('Are you sure you want to delete this poll?', async () => {
                        await deletePollFromFirebase(pollId);
                    });
                });
            });
        }

        // --- Side Drawer Logic ---
        const sideDrawer = document.getElementById('sideDrawer');
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const drawerOverlay = document.getElementById('drawerOverlay');

        function closeDrawer() {
            if (sideDrawer) sideDrawer.classList.remove('open');
            if (hamburgerBtn) hamburgerBtn.classList.remove('clicked');
            if (drawerOverlay) toggleVisibility(drawerOverlay, false);
        }

        function setupPageSwitching() {
            const navLinks = document.querySelectorAll('.main-nav .nav-link');
            const pageContents = document.querySelectorAll('.page-content');

            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const targetId = event.currentTarget.dataset.target;
                    closeDrawer();

                    navLinks.forEach(nav => nav.classList.remove('active'));
                    pageContents.forEach(page => page.classList.remove('active-page'));

                    event.currentTarget.classList.add('active');
                    const targetPage = document.getElementById(targetId);
                    if (targetPage) {
                        targetPage.classList.add('active-page');
                        if (targetId === 'analytics-page') {
                            updateAnalyticsAndChart();
                        } else if (targetId === 'what-if-page') {
                            loadSharedStoriesFirebase();
                        } else if (targetId === 'community-stories-page') {
                            loadAllStoriesFirebase();
                        } else if (targetId === 'polls-page') {
                            loadPollsFirebase();
                        } else if (targetId === 'settings-page') {
                            updateAdminPanelUI();
                        }
                    }
                });
            });

            const initialActiveLink = document.querySelector('.main-nav .nav-link.active');
            if (initialActiveLink) {
                const targetId = initialActiveLink.dataset.target;
                const targetPage = document.getElementById(targetId);
                if (targetPage) {
                    targetPage.classList.add('active-page');
                }
            }
        }

        async function handleWelcomeDisplayNameSubmit() {
            const welcomeDisplayNameInput = document.getElementById('welcomeDisplayNameInput');
            const name = welcomeDisplayNameInput.value.trim();

            if (!name) {
                showConfirmModal('Please enter a display name to start exploring.');
                return;
            }

            const success = await saveUserDisplayNameFirebase(name);
            if (success) {
                hideWelcomeModal();
                showMainContent();
                if (document.getElementById('what-if-page').classList.contains('active-page')) {
                    loadSharedStoriesFirebase();
                } else if (document.getElementById('community-stories-page').classList.contains('active-page')) {
                    loadAllStoriesFirebase();
                } else if (document.getElementById('polls-page').classList.contains('active-page')) {
                    loadPollsFirebase();
                }
            }
        }

        function hideWelcomeModal() {
            const welcomeModal = document.getElementById('welcomeModal');
            toggleVisibility(welcomeModal, false);
        }

        function showWelcomeModal() {
            const welcomeModal = document.getElementById('welcomeModal');
            toggleVisibility(welcomeModal, true, 'flex');
        }

        function showMainContent() {
            const mainContent = document.querySelector('.main-content');
            toggleVisibility(mainContent, true, 'grid');
        }

        function setupThemeSelection() {
            document.querySelectorAll('.theme-btn').forEach(button => {
                button.addEventListener('click', async (event) => {
                    const themeName = event.currentTarget.dataset.theme;
                    applyTheme(themeName);
                    await saveThemeFirebase(themeName);
                });
            });
        }

        function initDynamicBackground() {
            const bg = document.getElementById('dynamic-bg');
            const particleCount = 30;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'dynamic-particle';
                
                const size = Math.random() * 10 + 5;
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const duration = Math.random() * 20 + 15;
                const delay = Math.random() * 5;
                
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${x}%`;
                particle.style.top = `${y}%`;
                particle.style.animationDuration = `${duration}s`;
                particle.style.animationDelay = `${delay}s`;
                
                const colors = ['var(--accent-blue)', 'var(--accent-purple)', 'var(--accent-pink)'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                bg.appendChild(particle);
            }
        }

        function attachAddRemoveOptionListeners() {
            const addOptionBtn = document.getElementById('addOptionBtn');
            const pollOptionsContainer = document.getElementById('pollOptionsContainer');

            addOptionBtn.onclick = null;
            addOptionBtn.addEventListener('click', () => {
                const optionCount = pollOptionsContainer.children.length + 1;
                const newOptionItem = document.createElement('div');
                newOptionItem.className = 'poll-option-item';
                newOptionItem.innerHTML = `
                    <input type="text" class="poll-option-text" placeholder="Option ${optionCount} Text" required>
                    <input type="text" class="poll-option-image-url" placeholder="Option ${optionCount} Image URL (Optional)">
                    <button type="button" class="remove-option-btn" title="Remove this option"><i class="fas fa-minus-circle"></i></button>
                `;
                pollOptionsContainer.appendChild(newOptionItem);
                attachRemoveOptionListeners();
            });

            attachRemoveOptionListeners();
        }

        function attachRemoveOptionListeners() {
            document.querySelectorAll('.remove-option-btn').forEach(button => {
                button.onclick = null;
                button.addEventListener('click', (event) => {
                    const pollOptionsContainer = document.getElementById('pollOptionsContainer');
                    if (pollOptionsContainer.children.length > 2) {
                        event.target.closest('.poll-option-item').remove();
                        Array.from(pollOptionsContainer.children).forEach((item, index) => {
                            item.querySelector('.poll-option-text').placeholder = `Option ${index + 1} Text`;
                            item.querySelector('.poll-option-image-url').placeholder = `Option ${index + 1} Image URL (Optional)`;
                        });
                    } else {
                        showConfirmModal('A poll must have at least two options.');
                    }
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();

            window.addEventListener('resize', updateAnalyticsAndChart);

            const storyForm = document.getElementById('storyForm');
            if (storyForm) {
                storyForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const storyTextarea = document.getElementById('storyText');
                    const storyText = storyTextarea.value.trim();

                    if (!storyText) {
                        showConfirmModal('Please write your story before submitting.');
                        return;
                    }
                    await addStoryToFirebase(storyText);
                });
            }

            const saveDisplayNameBtn = document.getElementById('saveDisplayNameBtn');
            if (saveDisplayNameBtn) {
                saveDisplayNameBtn.addEventListener('click', async () => {
                    const name = document.getElementById('displayNameInput').value.trim();
                    await saveUserDisplayNameFirebase(name);
                });
            }

            const startExploringBtn = document.getElementById('startExploringBtn');
            if (startExploringBtn) {
                startExploringBtn.addEventListener('click', handleWelcomeDisplayNameSubmit);
            }

            const grantAdminBtn = document.getElementById('grantAdminBtn');
            if (grantAdminBtn) {
                grantAdminBtn.addEventListener('click', async () => {
                    const enteredPin = document.getElementById('adminPinInput').value.trim();
                    if (enteredPin === ADMIN_PIN) {
                        await grantAdminAccessFirebase(userId);
                        document.getElementById('adminPinInput').value = '';
                    } else {
                        showConfirmModal('Incorrect PIN. Please try again.');
                    }
                });
            }

            const revokeAdminBtn = document.getElementById('revokeAdminBtn');
            if (revokeAdminBtn) {
                revokeAdminBtn.addEventListener('click', async () => {
                    await showConfirmModal('Are you sure you want to revoke your admin access?', async () => {
                        await revokeAdminAccessFirebase(userId);
                    });
                });
            }

            const backToAllUsersBtn = document.getElementById('backToAllUsersBtn');
            if (backToAllUsersBtn) {
                backToAllUsersBtn.addEventListener('click', backToAllUsers);
            }

            const pollForm = document.getElementById('pollForm');
            if (pollForm) {
                pollForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const pollQuestion = document.getElementById('pollQuestion').value.trim();
                    const pollOptionInputs = document.querySelectorAll('.poll-option-item');
                    
                    const options = [];
                    let hasEmptyOptionText = false;
                    pollOptionInputs.forEach(item => {
                        const textInput = item.querySelector('.poll-option-text');
                        const imageUrlInput = item.querySelector('.poll-option-image-url');
                        const optionText = textInput.value.trim();
                        const optionImageUrl = imageUrlInput.value.trim();

                        if (!optionText) {
                            hasEmptyOptionText = true;
                        }
                        options.push({ text: optionText, imageUrl: optionImageUrl });
                    });

                    if (!pollQuestion) {
                        showConfirmModal('Please enter a poll question.');
                        return;
                    }
                    if (options.length < 2) {
                        showConfirmModal('Please add at least two poll options.');
                        return;
                    }
                    if (hasEmptyOptionText) {
                        showConfirmModal('Please ensure all poll options have text.');
                        return;
                    }

                    await addPollToFirebase(pollQuestion, options);
                });
            }
            attachAddRemoveOptionListeners();

            if (hamburgerBtn) {
                hamburgerBtn.addEventListener('click', () => {
                    if (sideDrawer) sideDrawer.classList.toggle('open');
                    hamburgerBtn.classList.toggle('clicked');

                    if (sideDrawer && sideDrawer.classList.contains('open')) {
                        toggleVisibility(drawerOverlay, true, 'block');
                    } else {
                        toggleVisibility(drawerOverlay, false);
                    }
                });
            }

            if (drawerOverlay) {
                drawerOverlay.addEventListener('click', () => {
                    closeDrawer();
                });
            }
        });
    </script>
</body>
</html>
